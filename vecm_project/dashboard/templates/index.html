<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VECM Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .metric-card {
        min-height: 140px;
      }
      .chart-container {
        height: 280px;
      }
      .slider {
        margin-top: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-1">VECM Daily Dashboard</h1>
          <p class="text-muted mb-0">Run ID: {{ dashboard.run_id or "N/A" }}</p>
        </div>
        <div class="mt-3 mt-md-0 d-flex gap-2 align-items-center">
          <a class="btn btn-outline-primary btn-sm" href="/config">Config Wizard</a>
          <span class="badge text-bg-primary">Read-only</span>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12 col-lg-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Latest Daily Signal</h2>
              {% if dashboard.latest_signal %}
              <dl class="row mb-0">
                <dt class="col-5">Date</dt>
                <dd class="col-7">{{ dashboard.latest_signal.date }}</dd>
                <dt class="col-5">Position</dt>
                <dd class="col-7">{{ dashboard.latest_signal.position }}</dd>
                <dt class="col-5">Return</dt>
                <dd class="col-7">{{ dashboard.latest_signal.ret }}</dd>
                <dt class="col-5">Cost</dt>
                <dd class="col-7">{{ dashboard.latest_signal.cost }}</dd>
                <dt class="col-5">Regime Prob.</dt>
                <dd class="col-7">{{ dashboard.latest_signal.p_regime }}</dd>
                <dt class="col-5">Delta Score</dt>
                <dd class="col-7">{{ dashboard.latest_signal.delta_score }}</dd>
                <dt class="col-5">Delta Mom12</dt>
                <dd class="col-7">{{ dashboard.latest_signal.delta_mom12 }}</dd>
              </dl>
              {% else %}
              <p class="text-muted mb-0">No daily CSV artifacts found.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Performance Metrics</h2>
              {% if dashboard.metrics %}
              <div class="row g-2">
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Sharpe (OOS)</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.sharpe_oos }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Max Drawdown</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.maxdd }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Turnover</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.turnover }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Turnover Annualised</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.turnover_annualised }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Trades</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.n_trades }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">CAGR</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.cagr }}</div>
                  </div>
                </div>
              </div>
              {% else %}
              <p class="text-muted mb-0">No metrics CSV found for this run.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
              <div>
                <h2 class="h6 mb-1">What-if Backtest</h2>
                <p class="text-muted mb-0">
                  Adjust parameters to re-evaluate metrics using cached features.
                </p>
              </div>
              <span class="badge text-bg-secondary" id="whatif-status">Idle</span>
            </div>

            <div class="row g-3 mt-2 align-items-end">
              <div class="col-12 col-md-7 col-lg-8">
                <label class="form-label" for="pair-selector">Pair</label>
                <select id="pair-selector" class="form-select">
                  {% if whatif_pairs %}
                    {% for option in whatif_pairs %}
                    <option value="{{ option.value }}" {% if backtest_defaults.pair == option.value %}selected{% endif %}>
                      {{ option.label }}
                    </option>
                    {% endfor %}
                  {% else %}
                    <option value="">No pair available</option>
                  {% endif %}
                </select>
              </div>
              <div class="col-12 col-md-5 col-lg-4">
                <button id="run-whatif" class="btn btn-primary w-100">Run What-If Analysis</button>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-12 col-md-6">
                <label class="form-label">p_th</label>
                <div id="slider-p-th" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-p-th"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">z_entry</label>
                <div id="slider-z-entry" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-z-entry"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">z_exit</label>
                <div id="slider-z-exit" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-z-exit"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">max_hold</label>
                <div id="slider-max-hold" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-max-hold"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">cooldown</label>
                <div id="slider-cooldown" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-cooldown"></span></div>
              </div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Sharpe (OOS)</div>
                  <div class="fs-5 fw-semibold" id="whatif-sharpe">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Max Drawdown</div>
                  <div class="fs-5 fw-semibold" id="whatif-maxdd">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Turnover</div>
                  <div class="fs-5 fw-semibold" id="whatif-turnover">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Turnover Annualised</div>
                  <div class="fs-5 fw-semibold" id="whatif-turnover-ann">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Trades</div>
                  <div class="fs-5 fw-semibold" id="whatif-trades">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">CAGR</div>
                  <div class="fs-5 fw-semibold" id="whatif-cagr">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h2 class="h5">Top Pairs: Spread &amp; Z-Score</h2>
        {% if dashboard.pair_charts %}
          <div class="row g-3">
            {% for chart in dashboard.pair_charts %}
            <div class="col-12 col-lg-4">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h3 class="h6 mb-3">{{ chart.pair }}</h3>
                  <div class="chart-container">
                    <canvas id="chart-{{ loop.index }}"></canvas>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No pair data available for charting.</p>
        {% endif %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    <script>
      const charts = {{ charts_json | safe }};
      const backtestDefaults = {{ backtest_defaults_json | safe }};
      charts.forEach((series, idx) => {
        const ctx = document.getElementById(`chart-${idx + 1}`);
        if (!ctx) return;
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: series.dates,
            datasets: [
              {
                label: 'Spread',
                data: series.spread,
                borderColor: '#0d6efd',
                tension: 0.2,
                yAxisID: 'y',
              },
              {
                label: 'Z-Score',
                data: series.zscore,
                borderColor: '#198754',
                tension: 0.2,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              y: {
                position: 'left',
                title: { display: true, text: 'Spread' },
              },
              y1: {
                position: 'right',
                title: { display: true, text: 'Z-Score' },
                grid: { drawOnChartArea: false },
              },
            },
          },
        });
      });

      const sliderConfigs = {
        p_th: { min: 0.5, max: 0.95, step: 0.01, value: backtestDefaults.p_th ?? 0.5 },
        z_entry: { min: 0.5, max: 2.5, step: 0.05, value: backtestDefaults.z_entry ?? 1.5 },
        z_exit: { min: 0.2, max: 1.5, step: 0.05, value: backtestDefaults.z_exit ?? 0.55 },
        max_hold: { min: 1, max: 60, step: 1, value: backtestDefaults.max_hold ?? 8 },
        cooldown: { min: 0, max: 30, step: 1, value: backtestDefaults.cooldown ?? 1 },
      };

      function initSlider(key, sliderId, valueId) {
        const config = sliderConfigs[key];
        const slider = document.getElementById(sliderId);
        const valueEl = document.getElementById(valueId);
        if (!slider || !valueEl) return null;
        noUiSlider.create(slider, {
          start: config.value,
          connect: [true, false],
          step: config.step,
          range: { min: config.min, max: config.max },
          format: {
            to: (value) => (Number.isInteger(config.step) ? Math.round(value) : Number(value).toFixed(2)),
            from: (value) => Number(value),
          },
        });
        valueEl.textContent = slider.noUiSlider.get();
        slider.noUiSlider.on("update", (values) => {
          valueEl.textContent = values[0];
        });
        return slider;
      }

      const sliders = {
        p_th: initSlider("p_th", "slider-p-th", "value-p-th"),
        z_entry: initSlider("z_entry", "slider-z-entry", "value-z-entry"),
        z_exit: initSlider("z_exit", "slider-z-exit", "value-z-exit"),
        max_hold: initSlider("max_hold", "slider-max-hold", "value-max-hold"),
        cooldown: initSlider("cooldown", "slider-cooldown", "value-cooldown"),
      };

      const statusBadge = document.getElementById("whatif-status");
      const pairSelector = document.getElementById("pair-selector");
      const runWhatifButton = document.getElementById("run-whatif");

      function setStatus(text, styleClass) {
        if (!statusBadge) return;
        statusBadge.textContent = text;
        statusBadge.className = `badge ${styleClass}`;
      }

      function gatherPayload() {
        return {
          pair: pairSelector?.value || backtestDefaults.pair || null,
          p_th: Number(sliders.p_th?.noUiSlider.get()),
          z_entry: Number(sliders.z_entry?.noUiSlider.get()),
          z_exit: Number(sliders.z_exit?.noUiSlider.get()),
          max_hold: Number(sliders.max_hold?.noUiSlider.get()),
          cooldown: Number(sliders.cooldown?.noUiSlider.get()),
        };
      }

      function formatNumber(value, decimals) {
        const parsed = Number(value);
        if (!Number.isFinite(parsed)) return "-";
        return parsed.toFixed(decimals);
      }

      function updateMetrics(data) {
        document.getElementById("whatif-sharpe").textContent = formatNumber(data.sharpe_oos, 3);
        document.getElementById("whatif-maxdd").textContent = formatNumber(data.maxdd, 4);
        document.getElementById("whatif-turnover").textContent = formatNumber(data.turnover, 3);
        document.getElementById("whatif-turnover-ann").textContent = formatNumber(data.turnover_annualised, 3);
        document.getElementById("whatif-trades").textContent = data.trades ?? data.n_trades ?? "-";
        document.getElementById("whatif-cagr").textContent = formatNumber(data.cagr, 4);
      }

      async function triggerBacktest() {
        if (!pairSelector?.value) {
          setStatus("No Pair", "text-bg-danger");
          return;
        }
        setStatus("Updating...", "text-bg-warning");
        try {
          const response = await fetch("/api/whatif", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(gatherPayload()),
          });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || data.error) {
            if (response.status === 429) {
              setStatus("Rate Limited", "text-bg-danger");
            } else {
              setStatus("Error", "text-bg-danger");
            }
            return;
          }
          updateMetrics(data);
          setStatus("Updated", "text-bg-success");
        } catch {
          setStatus("Error", "text-bg-danger");
        }
      }

      if (runWhatifButton) {
        runWhatifButton.addEventListener("click", triggerBacktest);
      }
      if (pairSelector) {
        pairSelector.addEventListener("change", () => setStatus("Idle", "text-bg-secondary"));
      }

      Object.values(sliders).forEach((slider) => {
        if (!slider) return;
        slider.noUiSlider.on("change", () => setStatus("Idle", "text-bg-secondary"));
      });

      if (pairSelector?.value) {
        triggerBacktest();
      }
    </script>
  </body>
</html>
