<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VECM Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .metric-card {
        min-height: 140px;
      }
      .chart-container {
        height: 280px;
      }
      .slider {
        margin-top: 12px;
      }
      .sim-stat {
        min-height: 78px;
      }
      .sim-table-wrap {
        max-height: 280px;
        overflow-y: auto;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-1">VECM Daily Dashboard</h1>
          <p class="text-muted mb-0">Run ID: {{ dashboard.run_id or "N/A" }}</p>
        </div>
        <div class="mt-3 mt-md-0 d-flex gap-2 align-items-center">
          <a class="btn btn-outline-primary btn-sm" href="/config">Config Wizard</a>
          <span class="badge text-bg-primary">Read-only</span>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12 col-lg-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Latest Daily Signal</h2>
              {% if dashboard.latest_signal %}
              <dl class="row mb-0">
                <dt class="col-5">Date</dt>
                <dd class="col-7">{{ dashboard.latest_signal.date }}</dd>
                <dt class="col-5">Position</dt>
                <dd class="col-7">{{ dashboard.latest_signal.position }}</dd>
                <dt class="col-5">Return</dt>
                <dd class="col-7">{{ dashboard.latest_signal.ret }}</dd>
                <dt class="col-5">Cost</dt>
                <dd class="col-7">{{ dashboard.latest_signal.cost }}</dd>
                <dt class="col-5">Regime Prob.</dt>
                <dd class="col-7">{{ dashboard.latest_signal.p_regime }}</dd>
                <dt class="col-5">Delta Score</dt>
                <dd class="col-7">{{ dashboard.latest_signal.delta_score }}</dd>
                <dt class="col-5">Delta Mom12</dt>
                <dd class="col-7">{{ dashboard.latest_signal.delta_mom12 }}</dd>
              </dl>
              {% else %}
              <p class="text-muted mb-0">No daily CSV artifacts found.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Performance Metrics</h2>
              {% if dashboard.metrics %}
              <div class="row g-2">
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Sharpe (OOS)</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.sharpe_oos }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Max Drawdown</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.maxdd }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Turnover</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.turnover }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Turnover Annualised</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.turnover_annualised }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Trades</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.n_trades }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">CAGR</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.cagr }}</div>
                  </div>
                </div>
              </div>
              {% else %}
              <p class="text-muted mb-0">No metrics CSV found for this run.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12">
          <div class="card shadow-sm border-info">
            <div class="card-body">
              <h2 class="h6 mb-2">Penjelasan Untuk Pemula</h2>
              <p class="mb-1">{{ beginner_explain.headline }}</p>
              <p class="mb-1 text-muted">{{ beginner_explain.signal_summary }}</p>
              <p class="mb-2">{{ beginner_explain.one_year_projection }}</p>
              <p class="small text-muted mb-3">{{ beginner_explain.caveat }}</p>

              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Metrik</th>
                      <th>Nilai</th>
                      <th>Arti Sederhana</th>
                      <th>Status Saat Ini</th>
                      <th>Implikasi Praktis</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for item in beginner_explain.metric_items %}
                    <tr>
                      <td>{{ item.name }}</td>
                      <td><strong>{{ item.value }}</strong></td>
                      <td>{{ item.meaning }}</td>
                      <td>{{ item.status }}</td>
                      <td>{{ item.implication }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
              <div>
                <h2 class="h6 mb-1">What-if Backtest</h2>
                <p class="text-muted mb-0">
                  Adjust parameters to re-evaluate metrics using cached features.
                </p>
                <p class="small text-muted mb-0">
                  Default preset: IDX long-only adaptive (no short selling).
                </p>
              </div>
              <span class="badge text-bg-secondary" id="whatif-status">Idle</span>
            </div>

            <div class="row g-3 mt-2 align-items-end">
              <div class="col-12 col-md-7 col-lg-8">
                <label class="form-label" for="pair-selector">Pair</label>
                <select id="pair-selector" class="form-select">
                  {% if whatif_pairs %}
                    {% for option in whatif_pairs %}
                    <option value="{{ option.value }}" {% if backtest_defaults.pair == option.value %}selected{% endif %}>
                      {{ option.label }}
                    </option>
                    {% endfor %}
                  {% else %}
                    <option value="">No pair available</option>
                  {% endif %}
                </select>
              </div>
              <div class="col-12 col-md-5 col-lg-4">
                <button id="run-whatif" class="btn btn-primary w-100">Run What-If Analysis</button>
              </div>
            </div>

            <div class="row g-3 mt-2">
              <div class="col-12 col-md-6">
                <label class="form-label">p_th</label>
                <div id="slider-p-th" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-p-th"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">z_entry</label>
                <div id="slider-z-entry" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-z-entry"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">z_exit</label>
                <div id="slider-z-exit" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-z-exit"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">max_hold</label>
                <div id="slider-max-hold" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-max-hold"></span></div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">cooldown</label>
                <div id="slider-cooldown" class="slider"></div>
                <div class="small text-muted mt-1">Value: <span id="value-cooldown"></span></div>
              </div>
            </div>

            <div class="row g-2 mt-3">
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Sharpe (OOS)</div>
                  <div class="fs-5 fw-semibold" id="whatif-sharpe">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Max Drawdown</div>
                  <div class="fs-5 fw-semibold" id="whatif-maxdd">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Turnover</div>
                  <div class="fs-5 fw-semibold" id="whatif-turnover">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Turnover Annualised</div>
                  <div class="fs-5 fw-semibold" id="whatif-turnover-ann">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">Trades</div>
                  <div class="fs-5 fw-semibold" id="whatif-trades">-</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="border rounded p-2 metric-card">
                  <div class="text-muted">CAGR</div>
                  <div class="fs-5 fw-semibold" id="whatif-cagr">-</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <h2 class="h5">Top Pairs: Spread &amp; Z-Score</h2>
        {% if dashboard.pair_charts %}
          <div class="row g-3">
            {% for chart in dashboard.pair_charts %}
            <div class="col-12 col-lg-4">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h3 class="h6 mb-3">{{ chart.pair }}</h3>
                  <div class="chart-container">
                    <canvas id="chart-{{ loop.index }}"></canvas>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No pair data available for charting.</p>
        {% endif %}

        <div class="mt-4">
          <h2 class="h5">Price &amp; Trade Execution Timeline</h2>
          {% if dashboard.execution_charts %}
            <p class="text-muted mb-3">
              BUY/SELL markers berasal dari trade log run terbaru untuk membantu melihat kenapa performa terjadi.
            </p>
            <div class="d-flex flex-wrap gap-2 mb-3">
              <span class="small text-muted me-2 align-self-center">Range:</span>
              <button type="button" class="btn btn-sm btn-outline-primary exec-range-btn active" data-range="3m">3M</button>
              <button type="button" class="btn btn-sm btn-outline-primary exec-range-btn" data-range="6m">6M</button>
              <button type="button" class="btn btn-sm btn-outline-primary exec-range-btn" data-range="1y">1Y</button>
              <button type="button" class="btn btn-sm btn-outline-primary exec-range-btn" data-range="full">Full</button>
            </div>
            <div class="row g-3">
              {% for chart in dashboard.execution_charts %}
              <div class="col-12 col-lg-6">
                <div class="card shadow-sm h-100">
                  <div class="card-body">
                    <h3 class="h6 mb-1">{{ chart.ticker }}</h3>
                    <p class="small text-muted mb-2">{{ chart.pair }}</p>
                    <div class="chart-container">
                      <canvas id="exec-chart-{{ loop.index }}"></canvas>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <div class="mt-4">
              <h2 class="h5">Trading Simulation Sheet</h2>
              <p class="text-muted mb-3">
                Simulasi transaksi per saham berdasarkan marker BUY/SELL.
                Asumsi notional per order: <strong id="sim-notional-label">-</strong>.
              </p>
              <div class="row g-3">
                {% for chart in dashboard.execution_charts %}
                <div class="col-12 col-lg-6">
                  <div class="card shadow-sm h-100">
                    <div class="card-body">
                      <h3 class="h6 mb-1">{{ chart.ticker }}</h3>
                      <p class="small text-muted mb-3">{{ chart.pair }}</p>

                      <div class="row g-2 mb-3">
                        <div class="col-6 col-xl-3">
                          <div class="border rounded p-2 sim-stat">
                            <div class="text-muted small">Total BUY Value</div>
                            <div class="fw-semibold" id="sim-buy-value-{{ loop.index }}">-</div>
                          </div>
                        </div>
                        <div class="col-6 col-xl-3">
                          <div class="border rounded p-2 sim-stat">
                            <div class="text-muted small">Total SELL Value</div>
                            <div class="fw-semibold" id="sim-sell-value-{{ loop.index }}">-</div>
                          </div>
                        </div>
                        <div class="col-6 col-xl-3">
                          <div class="border rounded p-2 sim-stat">
                            <div class="text-muted small">BUY/Sell Volume</div>
                            <div class="fw-semibold" id="sim-volume-{{ loop.index }}">-</div>
                          </div>
                        </div>
                        <div class="col-6 col-xl-3">
                          <div class="border rounded p-2 sim-stat">
                            <div class="text-muted small">Net Cashflow</div>
                            <div class="fw-semibold" id="sim-net-cash-{{ loop.index }}">-</div>
                          </div>
                        </div>
                      </div>

                      <div class="chart-container mb-3">
                        <canvas id="sim-chart-{{ loop.index }}"></canvas>
                      </div>

                      <div class="table-responsive sim-table-wrap">
                        <table class="table table-sm table-striped align-middle mb-0">
                          <thead>
                            <tr>
                              <th>#</th>
                              <th>Date</th>
                              <th>Action</th>
                              <th>Event</th>
                              <th>Price</th>
                              <th>Volume</th>
                              <th>Trade Value</th>
                              <th>Cum. Cashflow</th>
                            </tr>
                          </thead>
                          <tbody id="sim-table-{{ loop.index }}">
                            <tr>
                              <td colspan="8" class="text-muted">No simulation rows.</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          {% else %}
            <p class="text-muted">No execution chart data for the latest run.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    <script>
      const charts = {{ charts_json | safe }};
      const executionCharts = {{ execution_charts_json | safe }};
      const backtestDefaults = {{ backtest_defaults_json | safe }};
      const execChartInstances = [];
      const simChartInstances = [];
      const SIM_NOTIONAL_PER_ORDER = 10000000;
      const idrFormatter = new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        maximumFractionDigits: 0,
      });
      const numFormatter = new Intl.NumberFormat("id-ID", {
        maximumFractionDigits: 2,
      });
      const simNotionalLabel = document.getElementById("sim-notional-label");
      if (simNotionalLabel) {
        simNotionalLabel.textContent = idrFormatter.format(SIM_NOTIONAL_PER_ORDER);
      }

      function formatIDR(value) {
        const parsed = Number(value);
        if (!Number.isFinite(parsed)) return "-";
        return idrFormatter.format(parsed);
      }

      function formatQty(value) {
        const parsed = Number(value);
        if (!Number.isFinite(parsed)) return "-";
        return numFormatter.format(parsed);
      }

      function setText(id, text) {
        const el = document.getElementById(id);
        if (el) {
          el.textContent = text;
        }
      }

      charts.forEach((series, idx) => {
        const ctx = document.getElementById(`chart-${idx + 1}`);
        if (!ctx) return;
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: series.dates,
            datasets: [
              {
                label: 'Spread',
                data: series.spread,
                borderColor: '#0d6efd',
                tension: 0.2,
                yAxisID: 'y',
              },
              {
                label: 'Z-Score',
                data: series.zscore,
                borderColor: '#198754',
                tension: 0.2,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              y: {
                position: 'left',
                title: { display: true, text: 'Spread' },
              },
              y1: {
                position: 'right',
                title: { display: true, text: 'Z-Score' },
                grid: { drawOnChartArea: false },
              },
            },
          },
        });
      });

      function filterExecutionSeries(series, rangeKey) {
        const labels = series.dates || [];
        if (!labels.length || rangeKey === "full") {
          return {
            labels,
            prices: series.prices || [],
            buyPoints: series.buy_points || [],
            sellPoints: series.sell_points || [],
          };
        }
        const latest = new Date(labels[labels.length - 1]);
        if (Number.isNaN(latest.getTime())) {
          return {
            labels,
            prices: series.prices || [],
            buyPoints: series.buy_points || [],
            sellPoints: series.sell_points || [],
          };
        }
        let months = 0;
        if (rangeKey === "3m") months = 3;
        if (rangeKey === "6m") months = 6;
        if (rangeKey === "1y") months = 12;
        if (!months) {
          return {
            labels,
            prices: series.prices || [],
            buyPoints: series.buy_points || [],
            sellPoints: series.sell_points || [],
          };
        }
        const cutoff = new Date(latest);
        cutoff.setMonth(cutoff.getMonth() - months);
        const selectedIndexes = [];
        labels.forEach((d, i) => {
          const ts = new Date(d);
          if (!Number.isNaN(ts.getTime()) && ts >= cutoff) {
            selectedIndexes.push(i);
          }
        });
        if (!selectedIndexes.length) {
          return {
            labels,
            prices: series.prices || [],
            buyPoints: series.buy_points || [],
            sellPoints: series.sell_points || [],
          };
        }
        const selectedLabels = selectedIndexes.map((i) => labels[i]);
        const selectedSet = new Set(selectedLabels);
        const selectedPrices = selectedIndexes.map((i) => (series.prices || [])[i]);
        const buyPoints = (series.buy_points || []).filter((p) => selectedSet.has(p.x));
        const sellPoints = (series.sell_points || []).filter((p) => selectedSet.has(p.x));
        return {
          labels: selectedLabels,
          prices: selectedPrices,
          buyPoints,
          sellPoints,
        };
      }

      function buildSimulationRows(series, rangeKey) {
        const filtered = filterExecutionSeries(series, rangeKey);
        const events = [];
        (filtered.buyPoints || []).forEach((point) => {
          events.push({
            date: point.x,
            action: "BUY",
            event: point.event || "BUY",
            price: Number(point.y),
            sortHint: 0,
          });
        });
        (filtered.sellPoints || []).forEach((point) => {
          events.push({
            date: point.x,
            action: "SELL",
            event: point.event || "SELL",
            price: Number(point.y),
            sortHint: 1,
          });
        });
        events.sort((a, b) => {
          const da = new Date(a.date).getTime();
          const db = new Date(b.date).getTime();
          if (da !== db) return da - db;
          return a.sortHint - b.sortHint;
        });

        let cumulativeCash = 0;
        const rows = [];
        events.forEach((evt, idx) => {
          if (!Number.isFinite(evt.price) || evt.price <= 0) return;
          const volume = Math.max(1, Math.floor(SIM_NOTIONAL_PER_ORDER / evt.price));
          const tradeValue = volume * evt.price;
          const cashFlow = evt.action === "SELL" ? tradeValue : -tradeValue;
          cumulativeCash += cashFlow;
          rows.push({
            no: idx + 1,
            date: evt.date,
            action: evt.action,
            event: evt.event,
            price: evt.price,
            volume,
            tradeValue,
            cumulativeCash,
          });
        });
        return rows;
      }

      function renderSimulationSheet(rangeKey) {
        simChartInstances.forEach((chart) => chart.destroy());
        simChartInstances.length = 0;

        executionCharts.forEach((series, idx) => {
          const rows = buildSimulationRows(series, rangeKey);
          const tableBody = document.getElementById(`sim-table-${idx + 1}`);
          if (tableBody) {
            if (!rows.length) {
              tableBody.innerHTML = '<tr><td colspan="8" class="text-muted">No simulation rows for selected range.</td></tr>';
            } else {
              tableBody.innerHTML = rows
                .map(
                  (row) => `
                    <tr>
                      <td>${row.no}</td>
                      <td>${row.date}</td>
                      <td>${row.action}</td>
                      <td>${row.event}</td>
                      <td>${formatQty(row.price)}</td>
                      <td>${formatQty(row.volume)}</td>
                      <td>${formatIDR(row.tradeValue)}</td>
                      <td>${formatIDR(row.cumulativeCash)}</td>
                    </tr>
                  `
                )
                .join("");
            }
          }

          const totals = rows.reduce(
            (acc, row) => {
              if (row.action === "BUY") {
                acc.buyValue += row.tradeValue;
                acc.buyVol += row.volume;
              } else {
                acc.sellValue += row.tradeValue;
                acc.sellVol += row.volume;
              }
              return acc;
            },
            { buyValue: 0, sellValue: 0, buyVol: 0, sellVol: 0 }
          );
          const netCash = totals.sellValue - totals.buyValue;
          setText(`sim-buy-value-${idx + 1}`, formatIDR(totals.buyValue));
          setText(`sim-sell-value-${idx + 1}`, formatIDR(totals.sellValue));
          setText(
            `sim-volume-${idx + 1}`,
            `${formatQty(totals.buyVol)} / ${formatQty(totals.sellVol)}`
          );
          setText(`sim-net-cash-${idx + 1}`, formatIDR(netCash));

          const chartCanvas = document.getElementById(`sim-chart-${idx + 1}`);
          if (!chartCanvas) return;
          const chart = new Chart(chartCanvas, {
            type: "line",
            data: {
              labels: rows.map((row) => row.date),
              datasets: [
                {
                  label: "Cumulative Cashflow",
                  data: rows.map((row) => row.cumulativeCash),
                  borderColor: "#fd7e14",
                  backgroundColor: "#fd7e14",
                  borderWidth: 2,
                  pointRadius: 2,
                  tension: 0.15,
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  title: { display: true, text: "Cashflow (IDR)" },
                  ticks: {
                    callback: (value) => formatIDR(value),
                  },
                },
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return `${context.dataset.label}: ${formatIDR(context.parsed.y)}`;
                    },
                  },
                },
              },
            },
          });
          simChartInstances.push(chart);
        });
      }

      function renderExecutionCharts(rangeKey) {
        execChartInstances.forEach((chart) => chart.destroy());
        execChartInstances.length = 0;

        executionCharts.forEach((series, idx) => {
          const filtered = filterExecutionSeries(series, rangeKey);
          const ctx = document.getElementById(`exec-chart-${idx + 1}`);
          if (!ctx) return;
          const chart = new Chart(ctx, {
            type: "line",
            data: {
              labels: filtered.labels,
              datasets: [
                {
                  label: `${series.ticker} Price`,
                  data: filtered.prices,
                  borderColor: "#0d6efd",
                  backgroundColor: "#0d6efd",
                  tension: 0.2,
                  pointRadius: 0,
                  borderWidth: 2,
                },
                {
                  label: "BUY",
                  type: "scatter",
                  data: filtered.buyPoints,
                  showLine: false,
                  pointRadius: 5,
                  pointHoverRadius: 6,
                  pointBackgroundColor: "#198754",
                  pointBorderColor: "#198754",
                },
                {
                  label: "SELL",
                  type: "scatter",
                  data: filtered.sellPoints,
                  showLine: false,
                  pointRadius: 5,
                  pointHoverRadius: 6,
                  pointBackgroundColor: "#dc3545",
                  pointBorderColor: "#dc3545",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: {
                mode: "nearest",
                intersect: false,
              },
              plugins: {
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      const raw = context.raw || {};
                      if (raw && raw.event) {
                        return `${context.dataset.label}: ${context.parsed.y?.toFixed(2)} (${raw.event})`;
                      }
                      return `${context.dataset.label}: ${context.parsed.y?.toFixed(2)}`;
                    },
                  },
                },
              },
              scales: {
                y: {
                  title: { display: true, text: "Price" },
                },
              },
            },
          });
          execChartInstances.push(chart);
        });
      }

      renderExecutionCharts("3m");
      renderSimulationSheet("3m");
      const rangeButtons = document.querySelectorAll(".exec-range-btn");
      rangeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          rangeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          const selectedRange = btn.dataset.range || "full";
          renderExecutionCharts(selectedRange);
          renderSimulationSheet(selectedRange);
        });
      });

      const sliderConfigs = {
        p_th: { min: 0.5, max: 0.95, step: 0.01, value: backtestDefaults.p_th ?? 0.5 },
        z_entry: { min: 0.5, max: 2.5, step: 0.05, value: backtestDefaults.z_entry ?? 1.5 },
        z_exit: { min: 0.2, max: 1.5, step: 0.05, value: backtestDefaults.z_exit ?? 0.55 },
        max_hold: { min: 1, max: 60, step: 1, value: backtestDefaults.max_hold ?? 8 },
        cooldown: { min: 0, max: 30, step: 1, value: backtestDefaults.cooldown ?? 1 },
      };

      function initSlider(key, sliderId, valueId) {
        const config = sliderConfigs[key];
        const slider = document.getElementById(sliderId);
        const valueEl = document.getElementById(valueId);
        if (!slider || !valueEl) return null;
        noUiSlider.create(slider, {
          start: config.value,
          connect: [true, false],
          step: config.step,
          range: { min: config.min, max: config.max },
          format: {
            to: (value) => (Number.isInteger(config.step) ? Math.round(value) : Number(value).toFixed(2)),
            from: (value) => Number(value),
          },
        });
        valueEl.textContent = slider.noUiSlider.get();
        slider.noUiSlider.on("update", (values) => {
          valueEl.textContent = values[0];
        });
        return slider;
      }

      const sliders = {
        p_th: initSlider("p_th", "slider-p-th", "value-p-th"),
        z_entry: initSlider("z_entry", "slider-z-entry", "value-z-entry"),
        z_exit: initSlider("z_exit", "slider-z-exit", "value-z-exit"),
        max_hold: initSlider("max_hold", "slider-max-hold", "value-max-hold"),
        cooldown: initSlider("cooldown", "slider-cooldown", "value-cooldown"),
      };

      const statusBadge = document.getElementById("whatif-status");
      const pairSelector = document.getElementById("pair-selector");
      const runWhatifButton = document.getElementById("run-whatif");

      function setStatus(text, styleClass) {
        if (!statusBadge) return;
        statusBadge.textContent = text;
        statusBadge.className = `badge ${styleClass}`;
      }

      function gatherPayload() {
        return {
          pair: pairSelector?.value || backtestDefaults.pair || null,
          p_th: Number(sliders.p_th?.noUiSlider.get()),
          z_entry: Number(sliders.z_entry?.noUiSlider.get()),
          z_exit: Number(sliders.z_exit?.noUiSlider.get()),
          max_hold: Number(sliders.max_hold?.noUiSlider.get()),
          cooldown: Number(sliders.cooldown?.noUiSlider.get()),
        };
      }

      function formatNumber(value, decimals) {
        const parsed = Number(value);
        if (!Number.isFinite(parsed)) return "-";
        return parsed.toFixed(decimals);
      }

      function updateMetrics(data) {
        document.getElementById("whatif-sharpe").textContent = formatNumber(data.sharpe_oos, 3);
        document.getElementById("whatif-maxdd").textContent = formatNumber(data.maxdd, 4);
        document.getElementById("whatif-turnover").textContent = formatNumber(data.turnover, 3);
        document.getElementById("whatif-turnover-ann").textContent = formatNumber(data.turnover_annualised, 3);
        document.getElementById("whatif-trades").textContent = data.trades ?? data.n_trades ?? "-";
        document.getElementById("whatif-cagr").textContent = formatNumber(data.cagr, 4);
      }

      async function triggerBacktest() {
        if (!pairSelector?.value) {
          setStatus("No Pair", "text-bg-danger");
          return;
        }
        setStatus("Updating...", "text-bg-warning");
        try {
          const response = await fetch("/api/whatif", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(gatherPayload()),
          });
          const data = await response.json().catch(() => ({}));
          if (!response.ok || data.error) {
            if (response.status === 429) {
              setStatus("Rate Limited", "text-bg-danger");
            } else {
              setStatus("Error", "text-bg-danger");
            }
            return;
          }
          updateMetrics(data);
          setStatus("Updated", "text-bg-success");
        } catch {
          setStatus("Error", "text-bg-danger");
        }
      }

      if (runWhatifButton) {
        runWhatifButton.addEventListener("click", triggerBacktest);
      }
      if (pairSelector) {
        pairSelector.addEventListener("change", () => setStatus("Idle", "text-bg-secondary"));
      }

      Object.values(sliders).forEach((slider) => {
        if (!slider) return;
        slider.noUiSlider.on("change", () => setStatus("Idle", "text-bg-secondary"));
      });

      if (pairSelector?.value) {
        triggerBacktest();
      }
    </script>
  </body>
</html>
