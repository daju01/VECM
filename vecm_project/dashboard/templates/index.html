<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VECM Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .metric-card {
        min-height: 140px;
      }
      .chart-container {
        height: 280px;
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-start">
        <div>
          <h1 class="h3 mb-1">VECM Daily Dashboard</h1>
          <p class="text-muted mb-0">Run ID: {{ dashboard.run_id or "N/A" }}</p>
        </div>
        <div class="mt-3 mt-md-0 d-flex gap-2 align-items-center">
          <a class="btn btn-outline-primary btn-sm" href="/config">Config Wizard</a>
          <span class="badge text-bg-primary">Read-only</span>
        </div>
      </div>

      <div class="row g-3 mt-3">
        <div class="col-12 col-lg-5">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Latest Daily Signal</h2>
              {% if dashboard.latest_signal %}
              <dl class="row mb-0">
                <dt class="col-5">Date</dt>
                <dd class="col-7">{{ dashboard.latest_signal.date }}</dd>
                <dt class="col-5">Position</dt>
                <dd class="col-7">{{ dashboard.latest_signal.position }}</dd>
                <dt class="col-5">Return</dt>
                <dd class="col-7">{{ dashboard.latest_signal.ret }}</dd>
                <dt class="col-5">Cost</dt>
                <dd class="col-7">{{ dashboard.latest_signal.cost }}</dd>
                <dt class="col-5">Regime Prob.</dt>
                <dd class="col-7">{{ dashboard.latest_signal.p_regime }}</dd>
                <dt class="col-5">Delta Score</dt>
                <dd class="col-7">{{ dashboard.latest_signal.delta_score }}</dd>
                <dt class="col-5">Delta Mom12</dt>
                <dd class="col-7">{{ dashboard.latest_signal.delta_mom12 }}</dd>
              </dl>
              {% else %}
              <p class="text-muted mb-0">No daily CSV artifacts found.</p>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="col-12 col-lg-7">
          <div class="card shadow-sm">
            <div class="card-body">
              <h2 class="h6">Performance Metrics</h2>
              {% if dashboard.metrics %}
              <div class="row g-2">
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Sharpe (OOS)</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.sharpe_oos }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Max Drawdown</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.maxdd }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Turnover</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.turnover }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Turnover Annualised</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.turnover_annualised }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">Trades</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.n_trades }}</div>
                  </div>
                </div>
                <div class="col-6 col-md-4">
                  <div class="border rounded p-2 metric-card">
                    <div class="text-muted">CAGR</div>
                    <div class="fs-5 fw-semibold">{{ dashboard.metrics.cagr }}</div>
                  </div>
                </div>
              </div>
              {% else %}
              <p class="text-muted mb-0">No metrics CSV found for this run.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="mt-4">
        <h2 class="h5">Top Pairs: Spread &amp; Z-Score</h2>
        {% if dashboard.pair_charts %}
          <div class="row g-3">
            {% for chart in dashboard.pair_charts %}
            <div class="col-12 col-lg-4">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <h3 class="h6 mb-3">{{ chart.pair }}</h3>
                  <div class="chart-container">
                    <canvas id="chart-{{ loop.index }}"></canvas>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No pair data available for charting.</p>
        {% endif %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script>
      const charts = {{ charts_json | safe }};
      charts.forEach((series, idx) => {
        const ctx = document.getElementById(`chart-${idx + 1}`);
        if (!ctx) return;
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: series.dates,
            datasets: [
              {
                label: 'Spread',
                data: series.spread,
                borderColor: '#0d6efd',
                tension: 0.2,
                yAxisID: 'y',
              },
              {
                label: 'Z-Score',
                data: series.zscore,
                borderColor: '#198754',
                tension: 0.2,
                yAxisID: 'y1',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            scales: {
              y: {
                position: 'left',
                title: { display: true, text: 'Spread' },
              },
              y1: {
                position: 'right',
                title: { display: true, text: 'Z-Score' },
                grid: { drawOnChartArea: false },
              },
            },
          },
        });
      });
    </script>
  </body>
</html>
